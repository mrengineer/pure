<!DOCTYPE html>
<html>
<head>
    <title>WebUI с графиком</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="webui.js"></script>
    <script src="smoothie.js"></script>
    <style>
        #graph { 
            width: 100%; 
            height: 350px; 
            background: #111; /* Тёмный, но не чисто чёрный */
            border: 1px solid #444; 
        }
    </style>
</head>
<body class="container mt-4">
    <h1 id="main-status" class="mb-3">Ожидание...</h1>
    <p>Ваш ID: <span id="my-id-display">?</span></p>
    <p>Время сервера: <span id="timer-display">--:--:--</span></p>

    <hr>

    <h4>Живой график (случайные значения 0–100)</h4>
    <canvas id="graph"></canvas>

    <hr>

    <button class="btn btn-primary me-2" onclick="webui.handle_request('ping')">Отправить Пинг</button>
    <button class="btn btn-secondary" onclick="webui.handle_request('get_secret')">Получить секрет</button>

    <script>
        // Инициализация графика ПЕРЕД функциями обновления
        var s_graph = new TimeSeries();

        var smoothie = new SmoothieChart({
            responsive: true,                  // Важно для width:100%
            millisPerPixel: 3,                 // Скорость прокрутки
            grid: {
                fillStyle: '#111',             // Тёмный фон
                strokeStyle: '#444',           // Видимая сетка (серые линии)
                lineWidth: 1,
                millisPerLine: 500,
                verticalSections: 8,
                borderVisible: true            // Рамка по краям
            },
            labels: { 
                fillStyle: '#aaa',             // Цвет подписей min/max
                fontSize: 12
            },
            timestampFormatter: SmoothieChart.timeFormatter
        });

        smoothie.addTimeSeries(s_graph, {
            strokeStyle: '#00ff00',            // Зелёная линия
            fillStyle: 'rgba(0, 255, 0, 0.2)', // Полупрозрачная заливка
            lineWidth: 3
        });

        smoothie.streamTo(document.getElementById("graph"), 1000); // delay 1 сек для плавности

        // Теперь функции, которые вызывает C++
        function update_element(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                const el = document.getElementById(data.dom_id);
                if (el) el.innerText = data.payload;
            } catch (e) {
                console.error("Ошибка парсинга JSON:", e);
            }
        }

        function update_graph(value) {
            try {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    s_graph.append(new Date().getTime(), num);
                }
            } catch (e) {
                console.error("Ошибка графика:", e);
            }
        }
    </script>
</body>
</html>